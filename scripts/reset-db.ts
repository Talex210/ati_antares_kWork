// scripts/reset-db.ts

import { initializeDatabase, db, addPendingLoad } from '../src/database.js';
import { mockLoads } from '../src/mock/data.js';

/**
 * –°–∫—Ä–∏–ø—Ç –¥–ª—è —Å–±—Ä–æ—Å–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ.
 * - –û—á–∏—â–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—ã published_loads –∏ pending_loads.
 * - –ó–∞–ø–æ–ª–Ω—è–µ—Ç pending_loads –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ mock/data.ts.
 */
async function resetDatabase() {
  console.log('üöÄ –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞ —Å–±—Ä–æ—Å–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...');
  try {
    // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    await initializeDatabase();
    if (!db) {
      throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.');
    }
    console.log('‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞.');

    // 2. –û—á–∏—Å—Ç–∫–∞ —Ç–∞–±–ª–∏—Ü—ã –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã—Ö –≥—Ä—É–∑–æ–≤
    await db.run('DELETE FROM published_loads');
    console.log('üóëÔ∏è –¢–∞–±–ª–∏—Ü–∞ "published_loads" –æ—á–∏—â–µ–Ω–∞.');

    // 3. –û—á–∏—Å—Ç–∫–∞ —Ç–∞–±–ª–∏—Ü—ã –æ–∂–∏–¥–∞—é—â–∏—Ö –≥—Ä—É–∑–æ–≤ (—á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç–æ–≤)
    await db.run('DELETE FROM pending_loads');
    console.log('üóëÔ∏è –¢–∞–±–ª–∏—Ü–∞ "pending_loads" –æ—á–∏—â–µ–Ω–∞.');

    // 4. –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –æ–∂–∏–¥–∞—é—â–∏—Ö –≥—Ä—É–∑–æ–≤ –º–æ–∫-–¥–∞–Ω–Ω—ã–º–∏
    console.log('‚è≥ –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ "pending_loads" —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏...');
    for (const load of mockLoads) {
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é, —á—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö
      await addPendingLoad(load);
    }
    console.log(`‚úÖ –£—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ ${mockLoads.length} –≥—Ä—É–∑–æ–≤ –≤ "pending_loads".`);

    console.log('üéâ –°–∫—Ä–∏–ø—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!');

  } catch (error) {
    console.error('‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –≤–æ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–∞:', error);
  } finally {
    // 5. –ó–∞–∫—Ä—ã—Ç–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
    if (db) {
      await db.close();
      console.log('üîå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –∑–∞–∫—Ä—ã—Ç–æ.');
    }
  }
}

resetDatabase();
