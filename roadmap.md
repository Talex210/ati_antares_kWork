# Roadmap: Интеграция ATI.SU с Telegram (Node.js/TypeScript)

Этот документ описывает подробный план разработки проекта по автоматической публикации загрузок с ATI.SU в Telegram-группу. План составлен с учетом приоритета локальной разработки, использования современных и безопасных технологий, и развертывания на сервере на финальном этапе.

## Основные технологии

*   **Backend:** Node.js, TypeScript
*   **API-клиент:** Axios
*   **Telegram Bot:** node-telegram-bot-api
*   **Веб-фреймворк (для админ-панели):** Express.js
*   **База данных:** SQLite (для локальной разработки и простоты развертывания)
*   **Качество кода:** ESLint, Prettier

---

## План разработки

### Фаза 1: Локальная настройка и прототипирование (Оценка: 1 день) - ✔️

**Цель:** Создать полностью рабочее локальное окружение и прототип, работающий с имитацией API (mock-данными). 

1.  **Инициализация проекта:** ✔️
    *   ✔️ Настроить проект с `npm` и `TypeScript` (`npm init`, `tsc --init`).
    *   ✔️ Установить и настроить `ESLint` и `Prettier` для обеспечения единого стиля и качества кода.
    *   ✔️ Установить основные зависимости последних версий: `node-telegram-bot-api`, `axios`, `express`, `sqlite3`, `dotenv`.
    *   ✔️ Настроить `ts-node-dev` или `nodemon` для автоматической перезагрузки сервера при изменениях в коде.

2.  **Создание Mock-сервера для API ATI.SU:** ✔️
    *   ✔️ Написать простой сервер на `Express.js`, который будет имитировать ответы API ATI.SU.
    *   ✔️ Создать эндпоинты для получения списка загрузок (`/v1.0/loads/published`) и данных о логистах.
    *   ✔️ Подготовить несколько вариантов JSON-ответов на основе документации (`doc_API_ATI.txt` и официальной) для тестирования различных сценариев (новые грузы, отсутствие грузов и т.д.).

3.  **Настройка Telegram-бота и базы данных:** - ✔️
    *   ✔️ Зарегистрировать бота в `@BotFather` и сохранить токен в `.env` файл.
    *   ✔️ Написать базовый код для запуска бота и проверки связи с Telegram API.
    *   ✔️ Настроить `SQLite` для хранения "белого списка" логистов и, возможно, истории опубликованных грузов.

### Фаза 2: Разработка основной логики (Оценка: 2 дня)  - ✔️

**Цель:** Реализовать всю бизнес-логику бота, используя локальные mock-данные.

1.  **Взаимодействие с Mock API:**  - ✔️
    *   ✔️ Реализовать сервис для запросов к Mock API ATI.SU.
    *   ✔️ Настроить основной цикл (поллинг), который с заданной периодичностью (например, раз в 5 минут) опрашивает Mock API на предмет новых загрузок.

2.  **Фильтрация и обработка данных:** - ✔️
    *   ✔️ Реализовать логику фильтрации грузов по "белому списку" логистов из локальной БД.
    *   ✔️ Реализовать проверку на уникальность, чтобы не публиковать один и тот же груз дважды.
    *   ✔️ Настроить логику форматирования сообщения для Telegram на основе полученных данных.
    *   **Примечание:** Финальная корректировка фильтрации (поле `logistId`) будет произведена после получения доступа к реальному API ATI.SU и анализа структуры данных.

3.  **Подготовка к публикации через админ-панель:** - ✔️
    *   ✔️ Вместо немедленной отправки, бот будет сохранять новые отфильтрованные грузы в базу данных со статусом "ожидает публикации".
    *   ✔️ Расширить схему БД для хранения ожидающих грузов и их данных.

### Фаза 3: Разработка админ-панели для управления публикациями (Оценка: 2-3 дня)  - ✔️

**Цель:** Создать веб-интерфейс для управления логистами и ручной публикации грузов в нужные топики.

1.  **Backend (Express/TypeScript):**  - ✔️
    *   ✔️ Создать REST API эндпоинты для **управления списком логистов** (просмотр, добавление, удаление).
    *   ✔️ Создать REST API эндпоинт для **получения списка грузов, ожидающих публикации**.
    *   ✔️ Создать REST API эндпоинт для **публикации груза** (`POST /api/publish`), принимающий `loadId` и `topicId`.
    *   ✔️ Создать REST API эндпоинт для **отклонения груза** (удаление из списка ожидания).
    *   ✔️ Реализовать базовую, но надежную аутентификацию (например, по статичному паролю, хранящемуся в `.env`).

2.  **Frontend (HTML/CSS/Vanilla JS):**   - ✔️
    *   ✔️ Создать единую админ-панель с двумя разделами: "Управление логистами" и "Грузы на публикацию".
    *   ✔️ **Раздел "Грузы на публикацию":**
        *   ✔️ Отображать список ожидающих грузов с их ключевой информацией (маршрут, груз, ставка).
        *   ✔️ Для каждого груза добавить **выпадающий список с выбором топика** для публикации.
        *   ✔️ Добавить кнопки **"Опубликовать"** и **"Отклонить"**.
    *   ✔️ Написать JavaScript-код для взаимодействия с Backend API (получение списка грузов, отправка на публикацию/отклонение).
    *   ✔️ Применить базовые меры безопасности (экранирование вывода, защита от CSRF).

### Фаза 4: Развертывание и интеграция с реальным API (Оценка: 1 день) - ✔️

**Цель:** Перенести приложение на сервер, подключить к реальному API и запустить в продуктивном режиме.

1.  **Подготовка сервера:** - ✔️
    *   ✔️ **Создать аккаунт для клиента на выбранном хостинге (VPS).**
    *   ✔️ Настроить сервер: установить `Node.js`, `npm`, `Git`.

2.  **Развертывание приложения:** - ✔️
    *   ✔️ Загрузить код на сервер через `Git`.
    *   ✔️ Установить зависимости и настроить переменные окружения (`.env`) с реальными токенами (Telegram, ATI.SU).
    *   ✔️ Настроить `pm2` для автоматического запуска и мониторинга приложения.

3.  **Интеграция с реальным API ATI.SU:** - ✔️
    *   ✔️ Заменить в коде адреса Mock-сервера на реальные URL API ATI.SU.
    *   ✔️ Убедиться, что все запросы к API ATI.SU корректно используют токен доступа.
    *   **Примечание:** Финальная корректировка фильтрации (поле `logistId`) будет произведена после получения доступа к реальному API ATI.SU и анализа структуры данных.
    *   ✔️ С помощью админ-панели добавить в БД всех логистов из предоставленного заказчиком белого списка.
    *   ✔️ Провести финальное end-to-end тестирование с реальными данными.

5.  **Отладка программы и проверка функционала:** - ✔️


### Фаза 5: Доработки и оптимизация - ✔️

*   ✔️ **Реализована полная синхронизация с ATI.SU:**
    *   ✔️ Логика вынесена в модуль `synchronizer.ts`.
    *   ✔️ Реализовано удаление грузов из локальной БД, если их больше нет в ATI.SU.
*   ✔️ **Исправлено отображение типов транспорта:**
    *   ✔️ Добавлена поддержка декодирования битовых масок CarType
    *   ✔️ Добавлен тип 30 (Негабарит) в словарь типов
    *   ✔️ Убран температурный режим, добавлен способ загрузки/разгрузки
    *   ✔️ Синхронизировано отображение между админ-панелью и Telegram

*   ✔️ **Улучшена фильтрация грузов:**
    *   ✔️ Добавлены горизонтальные чекбоксы для фильтрации по логистам
    *   ✔️ Фильтр закрепляется при скролле
    *   ✔️ Сохранение состояния фильтра

*   ✔️ **Добавлен endpoint для ручного пересканирования грузов**

### Фаза 6: Массовая публикация/отклонение грузов - ✔️
1. Добавить чекбоксы для выбора грузов - сделано

2. Кнопки "Опубликовать выбранные" и "Отклонить выбранные" - сделано

3. Модальное окно для кнопки "Опубликовать выбранные" в которм будет выбора топика куда будем публиковать. - сделано

4. При нажатие на конпку "Отклонить выбранные" будет алерт как на кнопке опубликовать и отклонить с подтверждением перемещения.  - сделано

5. Обработка массовых операций на backend (можно последовательно или параллельно как по произовидельности будет лучше?)  - сдлано

6. Тестирование и проверка нового функционала. - сдлано

### Фаза 7: Управление топиками через админ-панель - ✔️

1. Новый раздел в админ-панели "Управление топиками"

2. Возможность добавлять топики: название + ID

3. Удаление и редактирование топиков

4. Топики будут автоматически появляться в выпадающем списке

---

**Важно:** План является гибким и может быть скорректирован в зависимости от деталей и возникающих сложностей.
